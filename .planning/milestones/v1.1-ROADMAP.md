# Milestone v1.1: Codebase Improvements

**Status:** ✅ SHIPPED 2026-01-23
**Phases:** 1-6
**Total Plans:** 21

## Overview

This milestone addresses technical debt, bugs, security concerns, and test coverage gaps in the NetBackup Prometheus exporter. The journey progresses from critical stability fixes through security hardening and architectural improvements, then expands test coverage, optimizes performance, and adds operational features. Each phase delivers measurable improvements while maintaining backwards compatibility.

## Phases

### Phase 1: Critical Fixes & Stability

**Goal**: Exporter runs reliably without crashes or resource leaks
**Depends on**: Nothing (first phase)
**Requirements**: BUG-01, FRAG-01, FRAG-03, TD-05, TD-06
**Plans**: 4 plans

Plans:

- [x] 01-01-PLAN.md - Version Detection Immutability (BUG-01 + FRAG-01)
- [x] 01-02-PLAN.md - URL Validation (FRAG-03)
- [x] 01-03-PLAN.md - Resource Cleanup (TD-05)
- [x] 01-04-PLAN.md - Error Channel Pattern (TD-06)

**Success Criteria Met:**

1. Exporter handles context cancellation during version detection without leaving config in inconsistent state
2. Exporter can be stopped and restarted multiple times without connection leaks
3. Exporter continues running even if metric collection errors occur (no fatal exits from goroutines)
4. Invalid URLs in configuration are caught during startup with clear error messages

### Phase 2: Security Hardening

**Goal**: Sensitive data is protected and connections are secure by default
**Depends on**: Nothing (independent of Phase 1)
**Requirements**: SEC-01, SEC-02, SEC-03
**Plans**: 2 plans

Plans:

- [x] 02-01-PLAN.md - TLS Enforcement & API Key Security (SEC-01 + SEC-02)
- [x] 02-02-PLAN.md - Rate Limiting & Retry with Backoff (SEC-03)

**Success Criteria Met:**

1. API key is not visible in memory dumps or logs (except when debug mode is explicitly enabled)
2. TLS verification is enabled by default; insecure mode requires explicit opt-in flag
3. Exporter handles API rate limits gracefully with automatic backoff and retry

### Phase 3: Architecture Improvements

**Goal**: Code is maintainable with clear ownership and minimal shared state
**Depends on**: Phase 1 (config mutation relates to BUG-01/FRAG-01)
**Requirements**: TD-01, TD-02, TD-03, FRAG-02, FRAG-04
**Plans**: 5 plans

Plans:

- [x] 03-01-PLAN.md - Tracer Wrapper with noop default (FRAG-04) - Wave 1
- [x] 03-02-PLAN.md - TracerProvider Injection (TD-02) - Wave 2
- [x] 03-03-PLAN.md - Structured Metric Keys (TD-03) - Wave 3
- [x] 03-04-PLAN.md - Immutable Config (TD-01) - Wave 3
- [x] 03-05-PLAN.md - Connection Lifecycle Integration (FRAG-02) - Wave 4

**Success Criteria Met:**

1. Configuration objects are immutable after initialization; version detection returns results without mutating config
2. OpenTelemetry dependencies are explicitly injected rather than accessed via global state
3. Metric keys use structured format that handles special characters safely
4. Connection pool lifecycle is explicitly managed with documented cleanup requirements
5. Tracer nil-checks are centralized in a single wrapper method (DRY principle)

### Phase 4: Test Coverage

**Goal**: Critical code paths have automated test coverage to prevent regressions
**Depends on**: Phases 1-3 complete (stable codebase makes testing easier)
**Requirements**: TD-04, TEST-01, TEST-02, TEST-03, TEST-04, TEST-05
**Plans**: 4 plans

Plans:

- [x] 04-01-PLAN.md - Main Package Integration Tests (TEST-01 + TD-04)
- [x] 04-02-PLAN.md - Testutil Coverage Expansion (TEST-02)
- [x] 04-03-PLAN.md - Telemetry Coverage Expansion (TEST-03)
- [x] 04-04-PLAN.md - Concurrent & Edge Case Tests (TEST-04 + TEST-05)

**Success Criteria Met:**

1. Main package test coverage increases from 0% to 60%+ with integration tests
2. Testutil package coverage increases from 51.9% to 97.5%
3. Telemetry package coverage increases from 76.6% to 83.7%
4. Tests verify concurrent access to collector without race conditions
5. Tests cover client error handling edge cases (network timeouts, unusual HTTP responses)

### Phase 5: Performance Optimizations

**Goal**: Scrape times are reduced and memory usage is predictable
**Depends on**: Phase 3 (PERF-04 benefits from TD-03 structured keys)
**Requirements**: PERF-01, PERF-02, PERF-03, PERF-04
**Plans**: 3 plans

Plans:

- [x] 05-01-PLAN.md - Batch Pagination (PERF-01) - Job fetching in batches of 100
- [x] 05-02-PLAN.md - Parallel Collection (PERF-02) - Storage and jobs collected concurrently
- [x] 05-03-PLAN.md - Pre-allocation Optimization (PERF-03) - Map/slice pre-allocation

**Success Criteria Met:**

1. Job fetching uses larger page sizes (100+ items), reducing number of sequential API calls by ~100x
2. Storage and job metrics collected in parallel, reducing scrape time to max(storage_time, jobs_time)
3. Metrics pre-allocated with capacity hints (100 job keys, 50 status keys)
4. String split operations minimized through structured metric keys

### Phase 6: Operational Features

**Goal**: Operators have visibility into exporter health and metrics freshness
**Depends on**: Nothing (features independent of previous phases)
**Requirements**: FEAT-01, FEAT-02, FEAT-03, FEAT-04
**Plans**: 3 plans

Plans:

- [x] 06-01-PLAN.md - Storage Metrics Caching (FEAT-01) - TTL-based cache with patrickmn/go-cache
- [x] 06-02-PLAN.md - Health Check and Up Metric (FEAT-02, FEAT-03) - nbu_up and staleness metrics
- [x] 06-03-PLAN.md - Dynamic Configuration Reload (FEAT-04) - SafeConfig + fsnotify + SIGHUP

**Success Criteria Met:**

1. Storage metrics cached and only refreshed at configured intervals (configurable TTL, default 5m)
2. Health endpoint verifies NetBackup connectivity and returns 503 when unreachable
3. Stale metrics identified via nbu_up and nbu_last_scrape_timestamp_seconds metrics
4. Configuration changes can be applied without restarting via SafeConfig + SIGHUP + fsnotify

## Milestone Summary

**Key Decisions:**

- Address concerns in priority order: Bugs → Security → Tech Debt → Performance → Features
- Maintain backwards compatibility for Prometheus metrics
- Incremental adoption of ImmutableConfig (deferred full migration to future phase)
- Options pattern for TracerProvider injection eliminates global state
- SafeConfig with RWMutex for thread-safe concurrent reads
- Cache hit updates last scrape timestamp (cached data is valid for staleness)

**Issues Resolved:**

- Fixed version detection state mutation on context cancellation (BUG-01)
- Eliminated 50+ tracer nil-checks through noop wrapper
- Replaced global OpenTelemetry state with explicit dependency injection
- Fixed resource leaks from HTTP client connection pooling
- Improved error handling in API version detection with fallback logic

**Issues Deferred:**

- Full ImmutableConfig adoption (Phase 3: incremental, gradual migration)
- Multi-collector framework for multiple NBU servers (beyond scope)
- Telemetry coverage 90%+ target (83.7% achievable without dependency injection)

**Technical Debt Incurred:**

None — all work maintains code quality standards. All phases verified (Phase 1: 93.75%, Phase 5-6: 100%).

---

_For current project status, see .planning/ROADMAP.md_

---

_Archived: 2026-01-23 as part of v1.1 milestone completion_
