---
phase: 02-security-hardening
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - internal/exporter/client.go
  - internal/exporter/client_test.go
autonomous: true

must_haves:
  truths:
    - "HTTP client retries on network errors, 429, and 5xx responses"
    - "Retry uses exponential backoff with configurable wait times"
    - "Retry-After header from 429 responses is respected"
    - "Connection pool is tuned for performance (MaxIdleConnsPerHost > 2)"
  artifacts:
    - path: "internal/exporter/client.go"
      provides: "Retry configuration and connection pool tuning"
      contains: "SetRetryCount"
    - path: "internal/exporter/client_test.go"
      provides: "Tests for retry behavior"
      contains: "TestNbuClient_Retry"
  key_links:
    - from: "internal/exporter/client.go"
      to: "resty.Client"
      via: "SetRetryCount chain"
      pattern: "SetRetryCount.*SetRetryWaitTime.*AddRetryCondition"
    - from: "internal/exporter/client.go"
      to: "http.Transport"
      via: "connection pool config"
      pattern: "MaxIdleConnsPerHost"
---

<objective>
Implement automatic retry with exponential backoff and connection pool tuning for resilient API communication.

Purpose: Addresses SEC-03 (rate limiting and backoff). Ensures the exporter gracefully handles API rate limits (429), transient failures (5xx), and network errors without overwhelming the NetBackup server.

Output: HTTP client configured with retry logic, Retry-After header support, and optimized connection pooling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-security-hardening/02-RESEARCH.md
@.planning/phases/02-security-hardening/02-01-SUMMARY.md

# Source files to modify

@internal/exporter/client.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure resty retry with exponential backoff</name>
  <files>internal/exporter/client.go</files>
  <action>
Update NewNbuClient() to configure retry behavior using resty's built-in retry mechanism:

1. Add retry-related constants at the top of the file:

```go
const (
    defaultTimeout        = 1 * time.Minute    // Default timeout for HTTP requests
    contentType           = "application/json" // Content type for API requests
    httpContentTypeHeader = "Content-Type"     // HTTP header name for content type

    // Retry configuration
    retryCount       = 3                // Number of retry attempts
    retryWaitTime    = 5 * time.Second  // Initial wait time between retries
    retryMaxWaitTime = 60 * time.Second // Maximum wait time between retries
)
```

1. Update the client initialization in NewNbuClient() to add retry configuration:

```go
client := resty.New().
    SetTLSClientConfig(&tls.Config{
        InsecureSkipVerify: cfg.NbuServer.InsecureSkipVerify,
        MinVersion:         tls.VersionTLS12,
    }).
    SetTimeout(defaultTimeout).
    // Configure retry with exponential backoff
    SetRetryCount(retryCount).
    SetRetryWaitTime(retryWaitTime).
    SetRetryMaxWaitTime(retryMaxWaitTime).
    AddRetryCondition(func(r *resty.Response, err error) bool {
        // Retry on network errors
        if err != nil {
            return true
        }
        // Retry on rate limiting (429) and server errors (5xx)
        return r.StatusCode() == http.StatusTooManyRequests ||
               r.StatusCode() >= 500
    })

// Enable automatic Retry-After header handling for 429 responses
client.AddRetryAfterErrorCondition()
```

1. Add import for "net/http" if not already present.

2. Add a debug log when retry is triggered (optional, helps with troubleshooting):
The resty library handles this internally with its OnRetry hook if needed later.
  </action>

  <verify>
Build verification: `go build ./...`
Unit test: `go test ./internal/exporter/... -v -run TestNewNbuClient`
Expected: Build succeeds, client initialization works
  </verify>
  <done>
- Retry count set to 3
- Initial retry wait time: 5 seconds
- Maximum retry wait time: 60 seconds
- Retry on: network errors, HTTP 429, HTTP 5xx
- Retry-After header automatically respected
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure connection pool for performance</name>
  <files>internal/exporter/client.go</files>
  <action>
Optimize the HTTP transport connection pool settings to prevent exhaustion and improve performance:

1. Add connection pool constants:

```go
const (
    // Connection pool configuration
    maxIdleConns        = 100              // Total idle connections across all hosts
    maxIdleConnsPerHost = 20               // Idle connections per host (default is 2, too low)
    idleConnTimeout     = 90 * time.Second // Timeout for idle connections
)
```

1. After creating the resty client in NewNbuClient(), configure the underlying HTTP transport:

```go
// Configure connection pool for performance
httpClient := client.GetClient()
httpClient.Transport = &http.Transport{
    MaxIdleConns:        maxIdleConns,
    MaxIdleConnsPerHost: maxIdleConnsPerHost,
    IdleConnTimeout:     idleConnTimeout,
    TLSHandshakeTimeout: 10 * time.Second,
    TLSClientConfig: &tls.Config{
        InsecureSkipVerify: cfg.NbuServer.InsecureSkipVerify,
        MinVersion:         tls.VersionTLS12,
    },
}
```

Note: This replaces the SetTLSClientConfig call since we're configuring the full transport.

1. Update the client creation to remove the SetTLSClientConfig call (now in Transport):

```go
client := resty.New().
    SetTimeout(defaultTimeout).
    SetRetryCount(retryCount).
    SetRetryWaitTime(retryWaitTime).
    SetRetryMaxWaitTime(retryMaxWaitTime).
    AddRetryCondition(func(r *resty.Response, err error) bool {
        if err != nil {
            return true
        }
        return r.StatusCode() == http.StatusTooManyRequests ||
               r.StatusCode() >= 500
    })

client.AddRetryAfterErrorCondition()

// Configure connection pool and TLS
httpClient := client.GetClient()
httpClient.Transport = &http.Transport{
    MaxIdleConns:        maxIdleConns,
    MaxIdleConnsPerHost: maxIdleConnsPerHost,
    IdleConnTimeout:     idleConnTimeout,
    TLSHandshakeTimeout: 10 * time.Second,
    TLSClientConfig: &tls.Config{
        InsecureSkipVerify: cfg.NbuServer.InsecureSkipVerify,
        MinVersion:         tls.VersionTLS12,
    },
}
```

  </action>
  <verify>
Build: `go build ./...`
Test: `go test ./internal/exporter/... -v`
Expected: All tests pass, client functions correctly
  </verify>
  <done>
- MaxIdleConns set to 100
- MaxIdleConnsPerHost set to 20 (up from default 2)
- IdleConnTimeout set to 90 seconds
- TLS configuration moved to Transport for unified config
  </done>
</task>

<task type="auto">
  <name>Task 3: Add tests for retry behavior</name>
  <files>internal/exporter/client_test.go</files>
  <action>
Add tests to verify retry configuration is applied correctly:

1. Add test for retry configuration verification:

```go
func TestNbuClient_RetryConfiguration(t *testing.T) {
    cfg := testutil.ValidConfig()
    client := NewNbuClient(cfg)
    require.NotNil(t, client)

    // Verify retry count is configured (resty exposes this)
    assert.Equal(t, 3, client.client.RetryCount)

    // Verify retry wait times
    assert.Equal(t, 5*time.Second, client.client.RetryWaitTime)
    assert.Equal(t, 60*time.Second, client.client.RetryMaxWaitTime)
}
```

1. Add test for connection pool configuration:

```go
func TestNbuClient_ConnectionPoolConfiguration(t *testing.T) {
    cfg := testutil.ValidConfig()
    client := NewNbuClient(cfg)
    require.NotNil(t, client)

    // Access underlying transport
    httpClient := client.client.GetClient()
    transport, ok := httpClient.Transport.(*http.Transport)
    require.True(t, ok, "Expected *http.Transport")

    // Verify connection pool settings
    assert.Equal(t, 100, transport.MaxIdleConns)
    assert.Equal(t, 20, transport.MaxIdleConnsPerHost)
    assert.Equal(t, 90*time.Second, transport.IdleConnTimeout)
}
```

1. Add test for TLS configuration in transport:

```go
func TestNbuClient_TLSInTransport(t *testing.T) {
    tests := []struct {
        name               string
        insecureSkipVerify bool
    }{
        {"secure", false},
        {"insecure", true},
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            cfg := testutil.ValidConfig()
            cfg.NbuServer.InsecureSkipVerify = tt.insecureSkipVerify
            if tt.insecureSkipVerify {
                t.Setenv("NBU_INSECURE_MODE", "true")
            }

            client := NewNbuClient(cfg)
            require.NotNil(t, client)

            httpClient := client.client.GetClient()
            transport, ok := httpClient.Transport.(*http.Transport)
            require.True(t, ok)
            require.NotNil(t, transport.TLSClientConfig)

            assert.Equal(t, tt.insecureSkipVerify, transport.TLSClientConfig.InsecureSkipVerify)
            assert.Equal(t, uint16(tls.VersionTLS12), transport.TLSClientConfig.MinVersion)
        })
    }
}
```

1. Add imports if needed: "crypto/tls", "net/http", "time"
  </action>

  <verify>
Run tests: `go test ./internal/exporter/... -v -run "TestNbuClient_Retry\|TestNbuClient_Connection\|TestNbuClient_TLS"`
Full test suite: `go test ./... -race`
Expected: All tests pass
  </verify>
  <done>
- Test verifies retry count (3) and wait times (5s initial, 60s max)
- Test verifies connection pool settings (100 idle, 20 per host, 90s timeout)
- Test verifies TLS 1.2 minimum in transport for both secure and insecure modes
- All tests pass with race detector
  </done>
</task>

</tasks>

<verification>
1. Build verification: `go build ./...`
2. Retry configuration tests: `go test ./internal/exporter/... -v -run TestNbuClient_Retry`
3. Connection pool tests: `go test ./internal/exporter/... -v -run TestNbuClient_Connection`
4. Full test suite: `go test ./... -race`
5. Code quality: `make sure` (if available)
</verification>

<success_criteria>

- [ ] Resty client configured with 3 retries
- [ ] Retry wait time: 5 seconds initial, 60 seconds maximum
- [ ] Retry condition triggers on: network errors, HTTP 429, HTTP 5xx
- [ ] Retry-After header handling enabled via AddRetryAfterErrorCondition()
- [ ] Connection pool: MaxIdleConns=100, MaxIdleConnsPerHost=20, IdleConnTimeout=90s
- [ ] TLS 1.2 minimum configured in http.Transport
- [ ] All tests pass with race detector
- [ ] Existing functionality unchanged (FetchData, Close, etc.)
</success_criteria>

<output>
After completion, create `.planning/phases/02-security-hardening/02-02-SUMMARY.md`
</output>
