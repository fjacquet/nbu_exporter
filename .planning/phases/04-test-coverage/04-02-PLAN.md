---
phase: 04-test-coverage
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/testutil/helpers_test.go
autonomous: true

must_haves:
  truths:
    - "testutil package coverage reaches 80%+"
    - "MockServerBuilder methods are fully tested"
    - "LoadTestData handles error cases"
    - "Assert helpers handle all msgAndArgs variations"
  artifacts:
    - path: "internal/testutil/helpers_test.go"
      provides: "Comprehensive tests for testutil package"
      min_lines: 250
  key_links:
    - from: "internal/testutil/helpers_test.go"
      to: "internal/testutil/helpers.go"
      via: "MockServerBuilder methods"
      pattern: "WithStorageEndpoint|WithCustomEndpoint"
---

<objective>
Increase testutil package coverage from 51.9% to 80%+ by adding tests for untested functions.

Purpose: Addresses TEST-02 requirement. The testutil package provides critical test infrastructure used across the codebase. Higher coverage ensures test helpers work correctly in edge cases.

Output: Expanded helpers_test.go with additional test cases
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@internal/testutil/helpers.go
@internal/testutil/helpers_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MockServerBuilder method tests</name>
  <files>internal/testutil/helpers_test.go</files>
  <action>
Add tests for untested MockServerBuilder methods in helpers_test.go.

Add to TestMockServerBuilder:

1. **TestWithStorageEndpoint**: Add test for WithStorageEndpoint
   - Create server with WithStorageEndpoint("13.0", storageResponse)
   - Make request to TestPathStorageUnits with version 13.0 header
   - Verify 200 OK response
   - Make request with wrong version header (12.0)
   - Verify 406 Not Acceptable response

2. **TestWithCustomEndpoint**: Add test for WithCustomEndpoint
   - Create custom handler that returns specific response
   - Add with WithCustomEndpoint("/custom/path", customHandler)
   - Make request to /custom/path
   - Verify expected response

3. **TestDefaultHandler404**: Test default handler for unregistered paths
   - Create server with only jobs endpoint
   - Make request to /nonexistent/path
   - Verify 404 Not Found response
   - Verify body contains "Endpoint not found"

4. **TestVersionDetectionNoMatch**: Test version detection with no matching version
   - Create server with WithVersionDetection(map[string]bool{"13.0": true})
   - Make request with version 3.0 header
   - Verify 406 Not Acceptable response (default case)

Use existing test patterns and closeResponseBody helper from the file.
</action>
<verify>
Run testutil tests with coverage:

```bash
go test -race -v -cover ./internal/testutil/... 2>&1 | tail -20
```

  </verify>
  <done>MockServerBuilder tests added, all tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Add LoadTestData and assertion helper edge case tests</name>
  <files>internal/testutil/helpers_test.go</files>
  <action>
Add edge case tests for LoadTestData and assertion helpers.

Add new test functions:

1. **TestLoadTestDataEdgeCases**: Test LoadTestData error handling
   - Note: LoadTestData calls t.Fatalf on error, so we can't test missing file case directly
   - Create a valid test file and verify it loads correctly
   - Create temporary file with specific content, verify LoadTestData returns that content
   - Use os.WriteFile to create temp file, defer os.Remove for cleanup

2. **TestAssertNoErrorWithMessage**: Test AssertNoError with custom message
   - Call with nil error and custom message - should not fail
   - Custom message format args are passed correctly

3. **TestAssertErrorWithMessage**: Test AssertError with custom message
   - Create mock testing.T (or skip this - can't easily test fatal behavior)
   - Verify function signature works with various arg counts

4. **TestAssertContainsEdgeCases**: Test AssertContains edge cases
   - Empty string contains empty substring
   - Unicode strings work correctly
   - Multiple occurrences handled correctly

5. **TestAssertEqualEdgeCases**: Test AssertEqual with various types
   - Compare integers
   - Compare strings
   - Compare nil values
   - Compare structs (by value, not pointer)

6. **TestValidateAPIVersion**: Test internal validateAPIVersion function
   - Note: This is a private function, test through MockServerBuilder behavior
   - Already covered by existing tests, skip if no additional coverage needed

7. **TestWriteJSONResponse**: Test internal writeJSONResponse
   - Note: Private function, test through MockServerBuilder behavior
   - Already covered by existing tests, skip if no additional coverage needed

Focus on the exported functions that don't have full coverage.
</action>
<verify>
Run testutil tests and check coverage:

```bash
go test -race -v -cover ./internal/testutil/... 2>&1 | tail -10
```

Verify coverage is 80%+:

```bash
go test -cover ./internal/testutil/... 2>&1 | grep coverage
```

  </verify>
  <done>Edge case tests added, testutil coverage reaches 80%+</done>
</task>

</tasks>

<verification>
1. All testutil tests pass: `go test -race -v ./internal/testutil/...`
2. Coverage target met: `go test -cover ./internal/testutil/...` shows 80%+
3. No new dependencies added
</verification>

<success_criteria>

- helpers_test.go expanded with additional test functions
- All tests pass with `go test -race -v ./internal/testutil/...`
- Coverage reaches 80%+ for testutil package
- Tests use existing patterns (t.Helper(), closeResponseBody)
  </success_criteria>

<output>
After completion, create `.planning/phases/04-test-coverage/04-02-SUMMARY.md`
</output>
