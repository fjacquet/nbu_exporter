---
phase: 04-test-coverage
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/telemetry/manager_test.go
autonomous: true

must_haves:
  truths:
    - "telemetry package coverage reaches 90%+"
    - "TracerProvider() method is tested"
    - "Sampling rate edge cases are tested"
    - "createExporter error handling is tested"
  artifacts:
    - path: "internal/telemetry/manager_test.go"
      provides: "Comprehensive tests for telemetry package"
      min_lines: 450
  key_links:
    - from: "internal/telemetry/manager_test.go"
      to: "internal/telemetry/manager.go"
      via: "TracerProvider method"
      pattern: "TracerProvider"
---

<objective>
Increase telemetry package coverage from 76.6% to 90%+ by adding tests for edge cases.

Purpose: Addresses TEST-03 requirement. The telemetry package handles OpenTelemetry integration which is critical for observability. Higher coverage ensures proper handling of initialization failures and edge cases.

Output: Expanded manager_test.go with additional test cases
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@internal/telemetry/manager.go
@internal/telemetry/manager_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add TracerProvider and initialization edge case tests</name>
  <files>internal/telemetry/manager_test.go</files>
  <action>
Add tests for TracerProvider() method and initialization edge cases.

Add new test functions:

1. **TestManagerTracerProvider**: Test TracerProvider() method

   - Create manager with disabled config
   - Initialize (which succeeds for disabled)
   - Verify TracerProvider() returns nil when disabled
   - Create manager with enabled config
   - After Initialize(), verify TracerProvider() returns non-nil (if init succeeded)
   - Note: TracerProvider returns the underlying \*sdktrace.TracerProvider

2. **TestManagerTracerProviderBeforeInit**: Test TracerProvider before Initialize

   - Create manager (don't call Initialize)
   - Verify TracerProvider() returns nil (tracerProvider field not set)

3. **TestManagerSamplingRateEdgeCases**: Test sampling rate edge cases

   - Rate > 1.0 (e.g., 1.5) should use AlwaysSample (createSampler logic)
   - Rate = 1.0 exactly uses AlwaysSample
   - Rate = 0.99 uses TraceIDRatioBased
   - Rate = 0 uses TraceIDRatioBased(0) - effectively never sample

4. **TestManagerDoubleInitialize**: Test calling Initialize twice

   - Create and Initialize manager
   - Call Initialize again
   - Verify no panic, second init should be idempotent or return early
   - Note: Current implementation doesn't guard against double init, test current behavior

5. **TestManagerDoubleShutdown**: Test calling Shutdown twice
   - Create, Initialize, and Shutdown manager
   - Call Shutdown again
   - Verify no panic, second shutdown should handle nil gracefully

Use existing test constants and patterns from the file.
</action>
<verify>
Run telemetry tests with coverage:

```bash
go test -race -v -cover ./internal/telemetry/... 2>&1 | tail -20
```

  </verify>
  <done>TracerProvider and edge case tests added, all tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Add context cancellation and resource creation tests</name>
  <files>internal/telemetry/manager_test.go</files>
  <action>
Add tests for context handling and resource creation edge cases.

Add new test functions:

1. **TestManagerInitializeContextCancelled**: Test Initialize with cancelled context

   - Create manager with valid enabled config
   - Create cancelled context using context.WithCancel, then cancel()
   - Call Initialize with cancelled context
   - Verify Initialize handles cancelled context gracefully
   - Note: OTLP exporter may or may not fail immediately on cancelled context

2. **TestManagerShutdownContextTimeout**: Test Shutdown with immediate timeout

   - Create and Initialize manager (if init succeeds)
   - Create context with very short timeout (1 nanosecond)
   - Call Shutdown with tight timeout context
   - Verify Shutdown returns or handles timeout
   - Note: Actual behavior depends on TracerProvider.Shutdown implementation

3. **TestManagerCreateResourceHostnameError**: Test createResource with hostname

   - This is implicitly tested - createResource uses os.Hostname()
   - Verify resource is created successfully in various conditions
   - Resource should have hostname attribute (or "unknown" on error)

4. **TestManagerHighSamplingRate**: Test sampling rate > 1.0

   - Create manager with SamplingRate: 2.0
   - Call createSampler()
   - Verify sampler is created (should use AlwaysSample for >= 1.0)

5. **TestManagerConfig**: Test Config struct fields
   - Create Config with all fields populated
   - Create manager with this config
   - Verify config is stored correctly (check manager.config field)

Check current coverage and add tests for any remaining uncovered lines. Use:

```bash
go test -coverprofile=cov.out ./internal/telemetry/...
go tool cover -func=cov.out | grep manager.go
```

  </action>
  <verify>
Run telemetry tests and verify coverage:
```bash
go test -race -v -cover ./internal/telemetry/... 2>&1 | tail -10
```
Check coverage percentage:
```bash
go test -cover ./internal/telemetry/... 2>&1 | grep coverage
```
  </verify>
  <done>Context and resource tests added, telemetry coverage reaches 90%+</done>
</task>

</tasks>

<verification>
1. All telemetry tests pass: `go test -race -v ./internal/telemetry/...`
2. Coverage target met: `go test -cover ./internal/telemetry/...` shows 90%+
3. No new dependencies added
4. Tests handle graceful degradation (OTLP collector may not be available)
</verification>

<success_criteria>

- manager_test.go expanded with TracerProvider tests and edge cases
- All tests pass with `go test -race -v ./internal/telemetry/...`
- Coverage reaches 90%+ for telemetry package
- Tests handle cases where OTLP collector is unavailable
  </success_criteria>

<output>
After completion, create `.planning/phases/04-test-coverage/04-03-SUMMARY.md`
</output>
