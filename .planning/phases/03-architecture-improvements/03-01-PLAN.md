---
phase: 03-architecture-improvements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/exporter/tracing.go
  - internal/exporter/tracing_test.go
autonomous: true

must_haves:
  truths:
    - "Tracer wrapper always returns valid span (never nil)"
    - "All span method calls are safe without nil-checks"
    - "Noop tracer has zero overhead when tracing disabled"
  artifacts:
    - path: "internal/exporter/tracing.go"
      provides: "TracerWrapper type with noop default"
      exports: ["TracerWrapper", "NewTracerWrapper", "StartSpan"]
    - path: "internal/exporter/tracing_test.go"
      provides: "Tests for TracerWrapper nil-safety"
      contains: "TestTracerWrapper"
  key_links:
    - from: "internal/exporter/tracing.go"
      to: "go.opentelemetry.io/otel/trace/noop"
      via: "noop.NewTracerProvider()"
      pattern: "noop\\.NewTracerProvider"
---

<objective>
Create a TracerWrapper type that uses noop.NewTracerProvider() as the default, ensuring all span operations are always safe without nil-checks.

Purpose: Centralizes tracer nil-safety (FRAG-04) by using OpenTelemetry's noop package, eliminating scattered nil-checks across the codebase.

Output: TracerWrapper type in tracing.go with comprehensive tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-architecture-improvements/03-RESEARCH.md

@internal/exporter/tracing.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TracerWrapper with noop default</name>
  <files>internal/exporter/tracing.go</files>
  <action>
Replace the existing createSpan helper with a TracerWrapper type that:

1. Add import for "go.opentelemetry.io/otel/trace/noop"

2. Create TracerWrapper struct:

```go
// TracerWrapper provides nil-safe tracing by using noop.TracerProvider as default.
// All span methods are guaranteed safe to call - no nil-checks needed.
type TracerWrapper struct {
    tracer trace.Tracer
}
```

1. Create NewTracerWrapper constructor:

```go
// NewTracerWrapper creates a TracerWrapper from a TracerProvider.
// If tp is nil, uses noop.NewTracerProvider() to ensure all operations are safe.
func NewTracerWrapper(tp trace.TracerProvider, instrumentationName string) *TracerWrapper {
    if tp == nil {
        tp = noop.NewTracerProvider()
    }
    return &TracerWrapper{
        tracer: tp.Tracer(instrumentationName),
    }
}
```

1. Add StartSpan method:

```go
// StartSpan creates a new span with the given operation name and kind.
// Always returns a valid span (noop if tracing disabled) - no nil-check needed.
func (w *TracerWrapper) StartSpan(ctx context.Context, operation string, kind trace.SpanKind) (context.Context, trace.Span) {
    return w.tracer.Start(ctx, operation, trace.WithSpanKind(kind))
}
```

1. Add Tracer accessor for direct tracer access if needed:

```go
// Tracer returns the underlying tracer for advanced use cases.
func (w *TracerWrapper) Tracer() trace.Tracer {
    return w.tracer
}
```

1. Keep the existing createSpan function for backward compatibility during migration, but mark it as deprecated:

```go
// Deprecated: Use TracerWrapper.StartSpan instead. This function will be removed
// after all call sites are migrated to use TracerWrapper.
func createSpan(ctx context.Context, tracer trace.Tracer, operation string, kind trace.SpanKind) (context.Context, trace.Span) {
    if tracer == nil {
        return ctx, nil
    }
    return tracer.Start(ctx, operation, trace.WithSpanKind(kind))
}
```

  </action>
  <verify>
- Run `go build ./...` - builds without errors
- Run `go vet ./...` - no issues
- Verify noop import is used: `grep -n "noop.NewTracerProvider" internal/exporter/tracing.go`
  </verify>
  <done>
TracerWrapper type exists with NewTracerWrapper constructor that defaults to noop.NewTracerProvider() when nil TracerProvider is passed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive tests for TracerWrapper</name>
  <files>internal/exporter/tracing_test.go</files>
  <action>
Create new test file with comprehensive tests for TracerWrapper:

```go
package exporter

import (
    "context"
    "testing"

    "go.opentelemetry.io/otel/trace"
    "go.opentelemetry.io/otel/trace/noop"
)

func TestNewTracerWrapper_NilProvider(t *testing.T) {
    // When TracerProvider is nil, should use noop
    wrapper := NewTracerWrapper(nil, "test-component")

    if wrapper == nil {
        t.Fatal("expected non-nil wrapper")
    }
    if wrapper.tracer == nil {
        t.Fatal("expected non-nil tracer")
    }
}

func TestNewTracerWrapper_WithProvider(t *testing.T) {
    // When TracerProvider is provided, should use it
    tp := noop.NewTracerProvider()
    wrapper := NewTracerWrapper(tp, "test-component")

    if wrapper == nil {
        t.Fatal("expected non-nil wrapper")
    }
    if wrapper.tracer == nil {
        t.Fatal("expected non-nil tracer")
    }
}

func TestTracerWrapper_StartSpan_NilSafe(t *testing.T) {
    // StartSpan should always return valid span, even with nil provider
    wrapper := NewTracerWrapper(nil, "test-component")
    ctx := context.Background()

    ctx, span := wrapper.StartSpan(ctx, "test-operation", trace.SpanKindClient)

    // Span should never be nil
    if span == nil {
        t.Fatal("expected non-nil span")
    }

    // All span methods should be safe to call
    span.SetAttributes() // Should not panic
    span.End()           // Should not panic
}

func TestTracerWrapper_SpanMethodsSafe(t *testing.T) {
    // All span methods should work without panics
    wrapper := NewTracerWrapper(nil, "test-component")
    ctx := context.Background()

    ctx, span := wrapper.StartSpan(ctx, "test-operation", trace.SpanKindInternal)
    defer span.End()

    // These should all be safe without nil-checks
    span.SetName("new-name")
    span.RecordError(nil)
    span.AddEvent("test-event")
    span.IsRecording() // Should return false for noop
    span.SpanContext()
}

func TestTracerWrapper_Tracer(t *testing.T) {
    // Tracer accessor should return non-nil tracer
    wrapper := NewTracerWrapper(nil, "test-component")

    tracer := wrapper.Tracer()
    if tracer == nil {
        t.Fatal("expected non-nil tracer from accessor")
    }
}

func TestTracerWrapper_ContextPropagation(t *testing.T) {
    // Context should properly propagate span
    wrapper := NewTracerWrapper(nil, "test-component")
    ctx := context.Background()

    ctx, parentSpan := wrapper.StartSpan(ctx, "parent", trace.SpanKindServer)
    defer parentSpan.End()

    // Child span should work with the modified context
    _, childSpan := wrapper.StartSpan(ctx, "child", trace.SpanKindClient)
    defer childSpan.End()

    // Both spans should be valid
    if parentSpan == nil || childSpan == nil {
        t.Fatal("expected non-nil spans")
    }
}
```

  </action>
  <verify>
- Run `go test ./internal/exporter/... -run TestTracerWrapper -v` - all tests pass
- Run `go test ./internal/exporter/... -race` - no race conditions
  </verify>
  <done>
All TracerWrapper tests pass, confirming nil-safety guarantee with noop provider.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify integration and commit</name>
  <files>internal/exporter/tracing.go, internal/exporter/tracing_test.go</files>
  <action>
1. Run full test suite to ensure no regressions:
   `go test ./... -race`

1. Run linter to ensure code quality:
   `go vet ./...`

2. Verify the noop import is correctly used:
   `grep -n "trace/noop" internal/exporter/tracing.go`

3. Commit the changes:

```bash
git add internal/exporter/tracing.go internal/exporter/tracing_test.go
git commit -m "feat(03-01): add TracerWrapper with noop default

Implements FRAG-04: centralize tracer nil-checks.

- Add TracerWrapper type using noop.NewTracerProvider() as default
- All span methods guaranteed safe without nil-checks
- Keep deprecated createSpan for backward compatibility
- Add comprehensive tests for nil-safety

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```

  </action>
  <verify>
- `go test ./... -race` passes
- `git log -1 --oneline` shows the new commit
  </verify>
  <done>
TracerWrapper implemented with noop default, tested, and committed.
  </done>
</task>

</tasks>

<verification>
1. TracerWrapper type exists in tracing.go
2. NewTracerWrapper returns wrapper with noop default when nil passed
3. StartSpan always returns non-nil span
4. All span methods callable without nil-checks
5. All tests pass with race detector
</verification>

<success_criteria>

- TracerWrapper type created with noop.NewTracerProvider() default
- NewTracerWrapper(nil, name) returns functional wrapper
- StartSpan always returns valid span (never nil)
- All existing tests continue to pass
- New TracerWrapper tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-architecture-improvements/03-01-SUMMARY.md`
</output>
